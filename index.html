<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BALOO BITE - WIN XNT</title>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
    <style>
        body {
            background: #1a1a1a;
            color: white;
            font-family: 'Permanent Marker', cursive;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .container {
            text-align: center;
            background: #2a2a2a;
            padding: 40px;
            border-radius: 20px;
            border: 4px solid #f39c12;
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.5);
        }

        h1 { color: #f39c12; font-size: 3rem; margin-bottom: 10px; }
        
        .treasury {
            font-size: 1.2rem;
            color: #2ecc71;
            margin-bottom: 20px;
        }

        .slot-machine {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
        }

        .reel {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #333;
            border: 3px solid #7f8c8d;
        }

        .btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            font-family: 'Permanent Marker', cursive;
            cursor: pointer;
            border-radius: 50px;
            transition: 0.3s;
        }

        .btn:hover { background: #e67e22; transform: scale(1.05); }
        .btn:disabled { background: #7f8c8d; cursor: not-allowed; }

        #status {
            margin-top: 20px;
            font-size: 1.2rem;
            height: 1.5rem;
            color: #f1c40f;
        }

        .wallet-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f39c12;
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Permanent Marker', cursive;
            z-index: 1000;
        }
    </style>
</head>
<body>

    <button class="wallet-btn" id="connectBtn" onclick="connectWallet()">CONNECT WALLET</button>

    <div class="container">
        <h1>BALOO BITE</h1>
        <div class="treasury">LIVE TREASURY: <span id="balance">0.00</span> XNT</div>
        
        <div class="slot-machine">
            <div class="reel" id="reel1">üêæ</div>
            <div class="reel" id="reel2">ü¶¥</div>
            <div class="reel" id="reel3">ü•à</div>
        </div>

        <button class="btn" id="playBtn" onclick="playGame()">BITE THE BONE (1 XNT)</button>
        <div id="status">READY TO BITE?</div>
    </div>

    <script>
        let walletAddress = null;
        const TREASURY_WALLET = "39fuVmCFZDpoirjpMoJUoBmWTj27c3Vk69hFf48QGtPe";
        const RPC_URL = "https://rpc.testnet.x1.xyz";

        async function updateTreasuryBalance() {
            try {
                const connection = new solanaWeb3.Connection(RPC_URL);
                const pubKey = new solanaWeb3.PublicKey(TREASURY_WALLET);
                const balance = await connection.getBalance(pubKey);
                document.getElementById('balance').innerText = (balance / 1000000000).toFixed(2);
            } catch (err) {
                console.log("Balance fetch pending...");
            }
        }

        async function connectWallet() {
            // Controleer specifiek op Backpack of algemene Solana provider
            const provider = window.backpack || window.solana;
            
            if (!provider) {
                alert("PLEASE INSTALL BACKPACK WALLET!");
                window.open("https://backpack.app/", "_blank");
                return;
            }

            try {
                const response = await provider.connect();
                walletAddress = response.publicKey.toString();
                document.getElementById('connectBtn').innerText = "CONNECTED: " + walletAddress.slice(0,4) + "...";
                document.getElementById('status').innerText = "WALLET LINKED!";
                console.log("Wallet connected:", walletAddress);
            } catch (err) {
                console.error(err);
                alert("CONNECTION FAILED. PLEASE UNLOCK BACKPACK.");
            }
        }

        async function playGame() {
            if (!walletAddress) {
                await connectWallet();
                if (!walletAddress) return;
            }

            const statusEl = document.getElementById('status');
            const playBtn = document.getElementById('playBtn');
            statusEl.innerText = "WAITING FOR APPROVAL...";
            playBtn.disabled = true;

            try {
                const connection = new solanaWeb3.Connection(RPC_URL, "confirmed");
                const provider = window.backpack || window.solana;

                const transaction = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey: new solanaWeb3.PublicKey(walletAddress),
                        toPubkey: new solanaWeb3.PublicKey(TREASURY_WALLET),
                        lamports: 1000000000 
                    })
                );

                const { signature } = await provider.signAndSendTransaction(transaction);
                statusEl.innerText = "CONFIRMING BITE...";
                await connection.confirmTransaction(signature);
                
                statusEl.innerText = "SPINNING...";
                
                const response = await fetch('/api/play.js', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ signature, player: walletAddress })
                });

                const result = await response.json();
                startSpinAnim(result.symbols, result.message);

            } catch (err) {
                console.error(err);
                statusEl.innerText = "ERROR - TRY AGAIN";
                playBtn.disabled = false;
            }
        }

        function startSpinAnim(finalSymbols, finalMessage) {
            const reels = ['reel1', 'reel2', 'reel3'];
            const items = ['üêæ', 'ü¶¥', 'ü•à', 'ü•á'];
            let spins = 0;
            
            const interval = setInterval(() => {
                reels.forEach(id => {
                    document.getElementById(id).innerText = items[Math.floor(Math.random() * items.length)];
                });
                spins++;
                if (spins > 20) {
                    clearInterval(interval);
                    reels.forEach((id, index) => {
                        document.getElementById(id).innerText = finalSymbols[index];
                    });
                    document.getElementById('status').innerText = finalMessage;
                    document.getElementById('playBtn').disabled = false;
                    updateTreasuryBalance();
                }
            }, 100);
        }

        setInterval(updateTreasuryBalance, 10000);
        window.addEventListener('load', updateTreasuryBalance);
    </script>
</body>
</html>
